<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>Google Photos Embed Code Generator</title>

  <!-- Page styles -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.min.css">
  <link rel="stylesheet" href="main.css">
  <style>
    h1 {
      font-size:20px;
    }
    h2 {
      font-size:16px;
    }

    table {
      border-collapse: collapse;
      margin: 10px;
    }
    
    table tr {
      border: 1;
      border-top: 1px solid #e0e0e0;
    }
    
    table td {
      border-bottom: 1px solid #e0e0e0;
      border-spacing: 0;
      padding: 5px
    }
  </style>
  <!-- load moment.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment-with-locales.min.js"></script>
  <script type="text/javascript">

    // ref: https://github.com/howdy39/google-picker-api-demo/blob/master/docs/index.html

    // The Browser API key obtained from the Google Developers Console.
    var developerKey = 'AIzaSyCrQKCG_Ly61zaO6-ba93BjTTb_W6v_r4Y';

    // The Client ID obtained from the Google Developers Console. Replace with your own Client ID.
    var clientId = "836573439566-pannen061gqgreoo4qv1na39on7smtpd.apps.googleusercontent.com";

    // Scope to use to access user's photos.
    var scope = ['https://www.googleapis.com/auth/photos'];

      var authApiLoaded = false;
      var pickerApiLoaded = false;
      var oauthToken;
      var viewIdForhandleAuthResult;

      // Use the API Loader script to load google.picker and gapi.auth.
      function onApiLoad() {
        gapi.load('auth', {'callback': onAuthApiLoad});
        gapi.load('picker', {'callback': onPickerApiLoad});
      }

      function onAuthApiLoad() {
        authApiLoaded = true;
      }

      function onPickerApiLoad() {
        pickerApiLoaded = true;
      }

      function handleAuthResult(authResult) {
        if (authResult && !authResult.error) {
          oauthToken = authResult.access_token;
          createPicker(true);
        }
      }

      // Create and render a Picker object for picking user Photos.
      function createPicker(setOAuthToken) {
        if (authApiLoaded && pickerApiLoaded) {
          var picker;
          
          if(authApiLoaded && oauthToken && setOAuthToken) {
            picker = new google.picker.PickerBuilder().
              addView(google.picker.ViewId.PHOTOS).
              enableFeature(google.picker.Feature.MULTISELECT_ENABLED).
              setOAuthToken(oauthToken).
              setDeveloperKey(developerKey).
              setCallback(pickerCallback).
              build();

            picker.setVisible(true);
          }
        }
      }


    // A simple callback implementation.
    function pickerCallback(data) {
      
      if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {

        // アルバム情報を取得
        var album = data[google.picker.Response.PARENTS][0];

        // 日付フォーマットをmoment.jsで扱う
        moment.locale("ja");

        // ここはあたらしくオブジェクトを作る必要はないけど..
        var pick_album_info = new Object();
        pick_album_info["album_name"] = album["name"];
        pick_album_info["album_updated_date"] = moment(album["lastEditedUtc"]).utc().format();
        pick_album_info["album_audience"] = album["audience"];

        // 選択した写真
        var doc = data[google.picker.Response.DOCUMENTS];

        // 選択した画像の各jsonから"thumbnails"Array内の最後のオブジェクト型内にあるurlを取り出す。結果は複数のurlのarrayが生成される
        var select_img_urls = doc.map(
          function get_thum_url(currentValue, index, array){
              // サムネイル用
              var thum_obj = currentValue["thumbnails"].slice(1)[0];
              // 埋め込みタグ用
              var embed_obj = currentValue["thumbnails"].slice(-1)[0];
              return ({"thum_obj":thum_obj,
                      "embed_obj":embed_obj,
                      });
          });

          // dom操作で描写するタグを生成する
          var embed_tags_str = ""
          for (var img_i = 0; img_i < select_img_urls.length; img_i++){
              
            // imgタグを生成する
            var embed_obj = select_img_urls[img_i].embed_obj
            var embed_tag_str = `<img src="${embed_obj.url}" width="${embed_obj.width}" height="${embed_obj.height}">`

            // テーブルに入れる
            embed_tags_str = embed_tags_str + `
              <tr>
                <td><img src="${select_img_urls[img_i].thum_obj.url}"></td>
                <td>
                  <textarea name="embed_tag" rows="3" cols="60" onclick="this.select();">${embed_tag_str}</textarea>
                </td>
              </tr>
            `;
          }

          // アルバム情報を含めたタグを生成
          var result_text = `
          <table  class="mdl-data-table mdl-js-data-table">
            <tr>
              <td>アルバム名</td>
              <td>${pick_album_info["album_name"]}</td>
            </tr>
            <tr>
              <td>audience(公開範囲)</td>
              <td>${pick_album_info["album_audience"]}</td>
            </tr>
            ${embed_tags_str}
          </table>
          `;
      }
      document.getElementById('result').innerHTML = result_text;
    }
  </script>
</head>

<body>
  <!--使い方を左, アルバム側を左にする-->
  <div class="mdl-grid">
    <!--<div class="mdl-cell mdl-cell--4-col mdl-cell--4-col-tablet mdl-cell--4-col-phone">-->
    <div class="mdl-cell mdl-cell--4-col">
      <h1>Googleフォト埋め込みタグジェネレーター</h1>
      <h2 id="-">ここは何？</h2>
      <p>Googleフォトのアルバム内にある写真から埋め込みタグを生成します。</p>
      <h2 id="-">利用方法</h2>
      <ul>
        <li>このページを開くと自動的にGoogleよりoAuthの認証が実行されます（問答無用で求められるので、この時点で同意できない方は利用はおやめ下さい）</li>
        <li>次にGoogleフォトのアルバム一覧が表示されますので、埋め込みタグを生成させたいアルバム内の写真を選択して下さい</li>
        <li>選択後に自動的に選択したアルバム情報と選択した写真の埋め込みタグが生成されます</li>
      </ul>
      <h2 id="-">参考</h2>
      <ul>
        <li><a href="https://developers.google.com/picker/">Picker  |  Google Developers</a>
          <ul>
            <li><a href="https://developers.google.com/picker/docs/#hiworld">Picker API Developer&#39;s Guide  |  Picker  |  Google Developers</a></li>
            <li><a href="https://developers.google.com/picker/docs/reference">Picker Class Reference  |  Picker  |  Google Developers</a></li>
            <li><a href="https://developers.google.com/picker/docs/results">Picker JSON Reference  |  Picker  |  Google Developers</a></li>
          </ul>
        </li>
        <li><a href="http://qiita.com/howdy39/items/a7de282e6dd5350f7a7c">Google Pickerを使ってWebサイトのUXを向上させよう - Qiita</a></li>
        <li><a href="https://getmdl.io/index.html">Material Design Lite</a></li>
      </ul>
      <h2 id="-">ライセンス情報</h2>
      <p>MIT License. See <a href="./LICENSE">LICENSE File</a></p>
    </div>
    <!--<div id="views" class="mdl-cell mdl-cell--8-col mdl-cell--8-col-tablet mdl-cell--8-col-phone">-->
    <div id="views" class="mdl-cell mdl-cell--8-col">
      <!--<a class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" onclick="createPicker();">-->

      <a class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
        Googleフォトのアルバム一覧を開く...
      </a>
      <br>
      <div id="result"></div>
    </div>
  </div>

  <!-- The Google API Loader script. -->
  <script type="text/javascript" src="https://apis.google.com/js/api.js?onload=onApiLoad"></script>
    <script type="text/javascript">
      Array.prototype.forEach.call(document.querySelectorAll('#views a'), function (ele) {
        ele.onclick = function () {
          // var viewId = google.picker.ViewId.PHOTOS;
          var setOAuthToken = true;
          
          // console.log(authApiLoaded);
          // console.log(oauthToken);
          if(authApiLoaded && !oauthToken) {
            // viewIdForhandleAuthResult = viewId;
            // console.log(typeof viewIdForhandleAuthResult)
            window.gapi.auth.authorize(
              {
                'client_id': clientId,
                'scope': scope,
                'immediate': false
              },
              handleAuthResult
            );
          } else {
            // console.log('not oauthToken')
            // createPicker(viewId, setOAuthToken);
            createPicker(setOAuthToken);
          }
          return false;
        }
      });
    </script>
    <script src="https://code.getmdl.io/1.1.3/material.min.js"></script>
  </body>
</body>

</html>